{% extends "base.html" %}

{% block title %}Account Statements - Razz Bank{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h2 style="color: #333; margin: 0;">Account Statements</h2>
                <p style="margin: 0.5rem 0; color: #666;">Account: {{ user[5] }} | {{ user[3] }}</p>
            </div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        </div>

        <div class="balance-card" style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 0.5rem;">Current Balance</h3>
            <p class="balance-amount">${{ "%.2f"|format(user[6]) }}</p>
        </div>

        <div class="statement-filters" style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin-bottom: 1rem;">Filter Transactions</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                    <label for="dateFrom">From Date:</label>
                    <input type="date" id="dateFrom" class="form-control" onchange="filterTransactions()">
                </div>
                <div>
                    <label for="dateTo">To Date:</label>
                    <input type="date" id="dateTo" class="form-control" onchange="filterTransactions()">
                </div>
                <div>
                    <label for="typeFilter">Transaction Type:</label>
                    <select id="typeFilter" class="form-control" onchange="filterTransactions()">
                        <option value="">All Types</option>
                        <option value="transfer">Transfers</option>
                        <option value="bill_payment">Bill Payments</option>
                        <option value="deposit">Deposits</option>
                        <option value="withdrawal">Withdrawals</option>
                    </select>
                </div>
                <div style="display: flex; align-items: end;">
                    <button onclick="clearFilters()" class="btn btn-secondary">Clear Filters</button>
                </div>
            </div>
        </div>

        <div class="transaction-history">
            <h3 style="margin-bottom: 1rem;">Transaction History</h3>
            {% if transactions %}
            <div class="table-responsive">
                <table class="transaction-table" id="transactionTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>From Account</th>
                            <th>To Account</th>
                            <th>Amount</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in transactions %}
                        <tr data-date="{{ txn.date }}" data-type="{{ txn.type }}">
                            <td>{{ txn.date }}</td>
                            <td>{{ txn.description }}</td>
                            <td>{{ txn.from_account }}</td>
                            <td>{{ txn.to_account }}</td>
                            <td class="transaction-amount {% if txn.amount > 0 %}positive{% else %}negative{% endif %}">
                                {% if txn.amount > 0 %}+{% endif %}${{ "%.2f"|format(txn.amount|abs) }}</td>
                            <td class="transaction-type">{{ txn.type|format_transaction_type }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 3rem; color: #666;">
                <p>No transactions found for your account.</p>
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Start Banking</a>
            </div>
            {% endif %}
        </div>

        <div class="statement-actions" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button onclick="window.print()" class="btn btn-secondary">Print Statement</button>
                <button onclick="exportToPDF()" class="btn btn-secondary">Export PDF</button>
                <button onclick="exportToCSV()" class="btn btn-secondary">Export CSV</button>
            </div>
        </div>
    </div>
</div>

<script>
function filterTransactions() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const rows = document.querySelectorAll('#transactionTable tbody tr');

    rows.forEach(row => {
        const rowDate = row.dataset.date.split(' ')[0];
        const rowType = row.dataset.type;
        
        let showRow = true;

        // Date filtering
        if (dateFrom && rowDate < dateFrom) showRow = false;
        if (dateTo && rowDate > dateTo) showRow = false;
        
        // Type filtering
        if (typeFilter && rowType !== typeFilter) showRow = false;

        row.style.display = showRow ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('typeFilter').value = '';
    filterTransactions();
}

function exportToCSV() {
    const table = document.getElementById('transactionTable');
    const rows = Array.from(table.querySelectorAll('tr:not([style*="display: none"])'));
    
    let csv = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('td, th'));
        return cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
    }).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'account_statement.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function exportToPDF() {
    window.razzBank.showAlert('PDF export feature coming soon', 'info');
}
</script>

<style>
@media print {
    .btn, .statement-filters, .statement-actions {
        display: none !important;
    }
    .table-responsive {
        overflow: visible !important;
    }
}

.table-responsive {
    overflow-x: auto;
}
</style>
{% endblock %}