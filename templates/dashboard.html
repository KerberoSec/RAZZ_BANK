{% extends "base.html" %}

{% block title %}Dashboard - Razz Bank Training Platform{% endblock %}

{% block content %}
<div class="container">
    <!-- Welcome Header with enhanced styling -->
    <div class="card gradient-border" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h2 style="color: #333; margin-bottom: 0.5rem; font-size: 2rem;">
                    Welcome back, {{ user[3] }}! üëã
                </h2>
                <p style="color: #666; margin: 0;">
                    Account: {{ user[5] }} | Role: 
                    <span class="security-badge" style="background: {{ 'linear-gradient(45deg, #ff6b6b, #ee5a52)' if user[7] == 'admin' else 'var(--success-color)' }};">
                        {{ user[7].title() }}
                    </span>
                </p>
            </div>
            <div style="text-align: right;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">
                    Last login: <span id="lastActivity">Just now</span>
                </p>
                <p style="margin: 0; color: #666; font-size: 0.9rem;">
                    Session: <span class="security-badge">Active</span>
                </p>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Account Balance Card -->
        <div class="card">
            <div class="balance-card">
                <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    üí∞ Account Balance
                </h3>
                <p class="balance-amount" style="font-size: 2.5rem; margin: 1rem 0;">
                    ${{ "%.2f"|format(user[6]) }}
                </p>
                <p class="account-number" style="margin: 0; opacity: 0.9;">
                    Account: {{ user[5] }}
                </p>
                
                <!-- Enhanced action buttons -->
                <div class="action-buttons" style="margin-top: 1.5rem;">
                    <button class="btn btn-primary transfer-btn">
                        <span>üí∏</span> Transfer Money
                    </button>
                    <a href="{{ url_for('statements') }}" class="btn btn-secondary" style="text-decoration: none;">
                        <span>üìÑ</span> View Statements
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions Card -->
        <div class="card">
            <h3 style="color: #333; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                ‚ö° Quick Actions
            </h3>
            <div class="quick-actions" style="display: grid; gap: 0.75rem;">
                <button class="btn btn-primary bill-pay-btn">
                    <span>üí≥</span> Pay Bills
                </button>
                <button class="btn btn-primary loan-apply-btn">
                    <span>üè†</span> Apply for Loan
                </button>
                <a href="#" class="btn btn-outline btn-secondary" style="text-decoration: none;">
                    <span>üì±</span> Mobile Deposit
                </a>
                <a href="{{ url_for('account_settings') }}" class="btn btn-outline btn-secondary" style="text-decoration: none;">
                    <span>‚öôÔ∏è</span> Account Settings
                </a>
                <a href="#" class="btn btn-outline btn-secondary" style="text-decoration: none;">
                    <span>üéß</span> Help & Support
                </a>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Card -->
    <div class="card" style="margin-top: 2rem;">
        <h3 style="color: #333; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            üìä Recent Activity
        </h3>
        <div id="recentTransactions">
            <div class="glass-card" style="padding: 1rem; text-align: center;">
                <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                <p style="margin: 0; color: #666;">Loading recent transactions...</p>
            </div>
        </div>
    </div>
    
    <!-- Vulnerability Training Panel (automatically added by JavaScript) -->
    
    <!-- Security Information -->
    <div class="card glass-card" style="margin-top: 2rem; border-left: 4px solid var(--info-color);">
        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--info-color);">
            üõ°Ô∏è Security Information
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div>
                <h5>Session Status</h5>
                <p style="margin: 0.5rem 0; color: #666;">
                    Your session will automatically expire after 30 minutes of inactivity.
                </p>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div style="width: 8px; height: 8px; background: var(--success-color); border-radius: 50%;"></div>
                    <span style="font-size: 0.9rem;">Session Active</span>
                </div>
            </div>
            <div>
                <h5>Account Protection</h5>
                <p style="margin: 0.5rem 0; color: #666;">
                    Your account is protected by advanced security measures.
                </p>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="security-badge" style="font-size: 0.8rem;">2FA Ready</span>
                    <span class="security-badge" style="font-size: 0.8rem;">Encrypted</span>
                    <span class="security-badge" style="font-size: 0.8rem;">Monitored</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Educational Context -->
    <div class="warning" style="margin-top: 2rem;">
        <h4 style="margin-bottom: 0.5rem;">üéì Educational Context</h4>
        <p style="margin-bottom: 1rem;">
            <strong>This is a training environment with intentional vulnerabilities:</strong>
        </p>
        <ul style="margin: 0; padding-left: 1.5rem;">
            <li>SQL Injection vulnerabilities in login forms</li>
            <li>Insecure Direct Object Reference (IDOR) in profile access</li>
            <li>Weak JWT implementation with predictable secrets</li>
            <li>Authorization bypass mechanisms</li>
        </ul>
        <p style="margin-top: 1rem; margin-bottom: 0;">
            <strong>Use responsibly for educational and authorized testing purposes only.</strong>
        </p>
    </div>
</div>

{% block extra_scripts %}
<script>
// Enhanced dashboard functionality
document.addEventListener('DOMContentLoaded', function() {
    // Update last activity timestamp
    const updateLastActivity = () => {
        const now = new Date();
        document.getElementById('lastActivity').textContent = now.toLocaleString();
    };
    updateLastActivity();
    
    // Update every minute
    setInterval(updateLastActivity, 60000);
    
    // Load real-time account balance (simulation)
    const balanceElement = document.querySelector('.balance-amount');
    if (balanceElement) {
        const originalBalance = parseFloat(balanceElement.textContent.replace(/[$,]/g, ''));
        
        // Simulate small balance fluctuations for realism
        setInterval(() => {
            const fluctuation = (Math.random() - 0.5) * 0.02; // ¬±$0.01 max
            const newBalance = originalBalance + fluctuation;
            balanceElement.textContent = `$${newBalance.toFixed(2)}`;
        }, 30000); // Every 30 seconds
    }
    
    // Session countdown timer
    let sessionTime = 30 * 60; // 30 minutes in seconds
    const sessionTimer = setInterval(() => {
        sessionTime--;
        if (sessionTime <= 0) {
            clearInterval(sessionTimer);
            window.razzBank.showAlert('Session expired. Please login again.', 'warning');
            setTimeout(() => {
                window.location.href = '/logout';
            }, 3000);
        }
    }, 1000);
    
    // Keyboard shortcuts for power users
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 't':
                    e.preventDefault();
                    document.querySelector('.transfer-btn')?.click();
                    break;
                case 'b':
                    e.preventDefault();
                    document.querySelector('.bill-pay-btn')?.click();
                    break;
                case 's':
                    e.preventDefault();
                    window.location.href = '/statements';
                    break;
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %}
